var CES;(function(CES){var Component=function(){function Component(){}return Component}();CES.Component=Component})(CES||(CES={}));var CES;(function(CES){var Entity=function(){function Entity(){this.id=Entity._id++;this.components={};this.onComponentAdded=new CES.Signal;this.onComponentRemoved=new CES.Signal}Entity.prototype.hasComponent=function(componentName){return this.components["$"+componentName]!==undefined};Entity.prototype.getComponent=function(componentName){return this.components["$"+componentName]};Entity.prototype.addComponent=function(component){this.components["$"+component.name]=component;this.onComponentAdded.emit(this,component.name)};Entity.prototype.removeComponent=function(componentName){var removedComponent=this.components["$"+componentName];this.components["$"+componentName]=undefined;this.onComponentRemoved.emit(this,componentName,removedComponent)};Entity._id=0;return Entity}();CES.Entity=Entity})(CES||(CES={}));var CES;(function(CES){var EntityList=function(){function EntityList(){this.head=null;this.tail=null;this.length=0;this.entities={}}EntityList.prototype.add=function(entity){var node=new CES.EntityNode(entity);if(this.head===null){this.head=this.tail=node}else{node.prev=this.tail;this.tail.next=node;this.tail=node}this.length++;this.entities[entity.id]=node};EntityList.prototype.remove=function(entity){var node=this.entities[entity.id];if(node===undefined){return}if(node.prev===null){this.head=node.next}else{node.prev.next=node.next}if(node.next===null){this.tail=node.prev}else{node.next.prev=node.prev}this.length--;delete this.entities[entity.id]};EntityList.prototype.has=function(entity){return this.entities[entity.id]!==undefined};EntityList.prototype.clear=function(){this.head=this.tail=null;this.length=0;this.entities={}};EntityList.prototype.toArray=function(){var array=[];for(var node=this.head;node;node=node.next){array.push(node.entity)}return array};return EntityList}();CES.EntityList=EntityList})(CES||(CES={}));var CES;(function(CES){var EntityNode=function(){function EntityNode(entity){this.entity=entity;this.next=null;this.prev=null}return EntityNode}();CES.EntityNode=EntityNode})(CES||(CES={}));var CES;(function(CES){var Family=function(){function Family(componentNames){this.componentNames=componentNames;this.entities=new CES.EntityList;this.entityAdded=new CES.Signal;this.entityRemoved=new CES.Signal}Family.prototype.getEntities=function(){return this.entities.toArray()};Family.prototype.addEntityIfMatch=function(entity){if(!this.entities.has(entity)&&this.matchEntity(entity)){this.entities.add(entity);this.entityAdded.emit(entity)}};Family.prototype.removeEntity=function(entity){if(this.entities.has(entity)){this.entities.remove(entity);this.entityRemoved.emit(entity)}};Family.prototype.onComponentAdded=function(entity,componentName){this.addEntityIfMatch(entity)};Family.prototype.onComponentRemoved=function(entity,componentName,removedComponent){if(!this.entities.has(entity)){return}for(var i=0;i<this.componentNames.length;++i){if(this.componentNames[i]===componentName){this.entities.remove(entity);this.entityRemoved.emit(entity,removedComponent)}}};Family.prototype.matchEntity=function(entity){for(var i=0;i<this.componentNames.length;i++){if(!entity.hasComponent(this.componentNames[i])){return false}}return true};return Family}();CES.Family=Family})(CES||(CES={}));var CES;(function(CES){var Signal=function(){function Signal(){this.listeners=[]}Signal.prototype.add=function(listener){this.listeners.push(listener)};Signal.prototype.remove=function(listener){for(var i=0;i<this.listeners.length;i++){if(listener===this.listeners[i]){this.listeners.splice(i,1);return true}}return false};Signal.prototype.emit=function(){var messages=[];for(var _i=0;_i<arguments.length;_i++){messages[_i-0]=arguments[_i]}for(var _a=0,_b=this.listeners;_a<_b.length;_a++){var listener=_b[_a];listener.apply(null,messages)}};return Signal}();CES.Signal=Signal})(CES||(CES={}));var CES;(function(CES){var System=function(){function System(){this.world=null}System.prototype.addedToWorld=function(world){this.world=world};System.prototype.removedFromWorld=function(){this.world=null};System.prototype.update=function(dt){throw new Error("Subclassed should override this method")};return System}();CES.System=System})(CES||(CES={}));var CES;(function(CES){var World=function(){function World(){this.families={};this.systems=[];this.entities=new CES.EntityList}World.prototype.addSystem=function(system){this.systems.push(system);system.addedToWorld(this);return this};World.prototype.removeSystem=function(system){for(var i=0;i<this.systems.length;i++){if(this.systems[i]===system){this.systems.splice(i,1);system.removedFromWorld()}}};World.prototype.addEntity=function(entity){var _this=this;for(var familyId in this.families){if(this.families.hasOwnProperty(familyId)){this.families[familyId].addEntityIfMatch(entity)}}entity.onComponentAdded.add(function(entity,componentName){_this.onComponentAdded(entity,componentName)});entity.onComponentRemoved.add(function(entity,componentName,component){_this.onComponentRemoved(entity,componentName,component)});this.entities.add(entity)};World.prototype.removeEntity=function(entity){for(var familyId in this.families){if(this.families.hasOwnProperty(familyId)){this.families[familyId].removeEntity(entity)}}this.entities.remove(entity)};World.prototype.getEntities=function(){var componentNames=[];for(var _i=0;_i<arguments.length;_i++){componentNames[_i-0]=arguments[_i]}var familyId=CES.World.getFamilyId(componentNames);this.ensureFamilyExists(componentNames);return this.families[familyId].getEntities()};World.prototype.update=function(dt){for(var _i=0,_a=this.systems;_i<_a.length;_i++){var system=_a[_i];system.update(dt)}};World.prototype.entityAdded=function(){var componentNames=[];for(var _i=0;_i<arguments.length;_i++){componentNames[_i-0]=arguments[_i]}var familyId=CES.World.getFamilyId(componentNames);this.ensureFamilyExists(componentNames);return this.families[familyId].entityAdded};World.prototype.entityRemoved=function(){var componentNames=[];for(var _i=0;_i<arguments.length;_i++){componentNames[_i-0]=arguments[_i]}var familyId=CES.World.getFamilyId(componentNames);this.ensureFamilyExists(componentNames);return this.families[familyId].entityRemoved};World.prototype.ensureFamilyExists=function(components){var families=this.families;var familyId=CES.World.getFamilyId(components);if(!families[familyId]){families[familyId]=new CES.Family(Array.prototype.slice.call(components));for(var node=this.entities.head;node;node=node.next){families[familyId].addEntityIfMatch(node.entity)}}};World.getFamilyId=function(components){return"$"+Array.prototype.join.call(components,",")};World.prototype.onComponentAdded=function(entity,componentName){for(var familyId in this.families){if(this.families.hasOwnProperty(familyId)){this.families[familyId].onComponentAdded(entity,componentName)}}};World.prototype.onComponentRemoved=function(entity,componentName,component){for(var familyId in this.families){if(this.families.hasOwnProperty(familyId)){this.families[familyId].onComponentRemoved(entity,componentName,component)}}};return World}();CES.World=World})(CES||(CES={}));
